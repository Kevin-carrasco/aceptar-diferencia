---
title: "03-analisis_multinivel"
author: "Equipo EDUMER"
date: "2022-08-11"
output: html_document
---

Este .rmd contiene el análisis multinivel realizado para evaluar las hipótesis establecidas en el proyecto de investigación.

* Cargar paquetes

```{r}
pacman::p_load(dplyr, ggplot2, sjPlot, summarytools, corrplot, ltm, lme4, stargazer, texreg, scales)
load("IPO/input/data/proc/data.RData")
load("IPO/input/data/proc/data_comuna.RData")
```

# Crear indices de aceptacion de la diversidad en estudiantes (dependiente) y apoderados (independiente)

## estudiantes
```{r}
data$est_piel_rec <- as.numeric(data$est_piel)
data$est_clase_rec <- as.numeric(data$est_clase)
data$est_religion_rec <- as.numeric(data$est_religion)
data$est_orien_sexual_rec <- as.numeric(data$est_orien_sexual)
data$est_region_rec <- as.numeric(data$est_region)
data$est_pais_rec <- as.numeric(data$est_pais)
data$est_indigena_rec <- as.numeric(data$est_indigena)

corrplot.mixed(cor(dplyr::select(data, est_piel_rec,
                                 est_clase_rec,
                                 est_religion_rec,
                                 est_orien_sexual_rec,
                                 est_region_rec,
                                 est_pais_rec,
                                 est_indigena_rec),
                   method = "spearman",
                   use = "complete.obs"))
```

```{r}
ltm::cronbach.alpha(data %>%
  dplyr::select(est_piel_rec, est_clase_rec, est_religion_rec, est_orien_sexual_rec, est_region_rec, est_pais_rec, est_indigena_rec), na.rm=TRUE)
```

```{r}
data$est_piel_rec <- car::recode(data$est_piel_rec, "1=0; 2=1")
data$est_clase_rec <- car::recode(data$est_clase_rec, "1=0; 2=1")
data$est_religion_rec <- car::recode(data$est_religion_rec, "1=0; 2=1")
data$est_orien_sexual_rec <- car::recode(data$est_orien_sexual_rec, "1=0; 2=1")
data$est_region_rec <- car::recode(data$est_region_rec, "1=0; 2=1")
data$est_pais_rec <- car::recode(data$est_pais_rec, "1=0; 2=1")
data$est_indigena_rec <- car::recode(data$est_indigena_rec, "1=0; 2=1")

data <- data %>% rowwise() %>% mutate(est_acc_div = sum(est_piel_rec, est_clase_rec, est_religion_rec, est_orien_sexual_rec, est_region_rec, est_pais_rec, est_indigena_rec))

data_comuna <- rename(data_comuna, cod_com_alu=p10comuna)

base <- merge(data, data_comuna, by="cod_com_alu")

# etnia reescalar
base$etnia2 <- ntile(base$prop_etnia,3) # categorizar el puntaje en bajo, medio y alto
base$etnia2 <- factor(base$etnia2, labels = c("Bajo", "Medio", "Alto"))

# inmigrante reescalar
base$inmigrante2 <- ntile(base$prop_inm,3) # categorizar el puntaje en bajo, medio y alto
base$inmigrante2 <- factor(base$inmigrante2, labels = c("Bajo", "Medio", "Alto"))

base$etnia2 <- sjlabelled::set_label(base$etnia2, 'Proporción de personas que se identifica con alguna etnia')
base$inmigrante2 <- sjlabelled::set_label(base$inmigrante2, 'Proporción de inmigrantes')
base$escolaridad <- sjlabelled::set_label(base$escolaridad, 'Promedio de escolaridad')

base <- base %>% dplyr::select(est_acc_div, educacion_rec, libros_rec, apod_acc_div, civic, ap_dis, mean_apdis, mrbd, escolaridad, etnia2, inmigrante2) %>% na.omit()
```

# primera estimacion (mrbd)

```{r}
reg0 <- lmer(est_acc_div ~ 1 + (1 | mrbd), data=base)
reg1 <- lmer(est_acc_div ~ educacion_rec + libros_rec + (1 | mrbd), data=base)
reg2 <- lmer(est_acc_div ~ educacion_rec + libros_rec + apod_acc_div + (1 | mrbd), data=base)
reg3 <- lmer(est_acc_div ~ educacion_rec + libros_rec + apod_acc_div + civic + ap_dis + mean_apdis + (1 | mrbd), data=base)
reg4 <- lmer(est_acc_div ~ educacion_rec + libros_rec + apod_acc_div + civic + ap_dis + mean_apdis + etnia2 + inmigrante2 + escolaridad + (1 | mrbd), data=base)
```

```{r}
screenreg(list(reg0, reg1, reg2, reg3, reg4))
```

# Interacciones

```{r}
# actitudes apod x escuela
reg6 <- lmer(est_acc_div ~ educacion_rec + libros_rec + apod_acc_div*civic + civic + ap_dis + mean_apdis + etnia2 + inmigrante2 + escolaridad + (1 | mrbd), data=base)
reg7 <- lmer(est_acc_div ~ educacion_rec + libros_rec + apod_acc_div*ap_dis + civic + ap_dis + mean_apdis + etnia2 + inmigrante2 + escolaridad + (1 | mrbd), data=base)
# actitudes apod x territorio
reg8 <- lmer(est_acc_div ~ educacion_rec + libros_rec + apod_acc_div*inmigrante2 + civic + ap_dis + mean_apdis + etnia2 + inmigrante2 + escolaridad + (1 | mrbd), data=base)
reg9 <- lmer(est_acc_div ~ educacion_rec + libros_rec + apod_acc_div*etnia2 + civic + ap_dis + mean_apdis + etnia2 + inmigrante2 + escolaridad + (1 | mrbd), data=base)
reg10 <- lmer(est_acc_div ~ educacion_rec + libros_rec + apod_acc_div*escolaridad + civic + ap_dis + mean_apdis + etnia2 + inmigrante2 + escolaridad + (1 | mrbd), data=base)
```

```{r}
screenreg(list(reg6, reg7, reg8, reg9, reg10))
```


```{r results='asis', message=FALSE, echo=FALSE}  
htmlreg(list(reg1, reg2, reg3, reg4), 
         custom.model.names = c("Modelo 1",
                               "Modelo 2",
                               "Modelo 3",
                               "Modelo 4"), 
        custom.note = "$***p <$ 0.001, $**p <$ 0.01, $*p <$ 0.05",
        custom.coef.names = c("Intercepto", 
                              "Educación media <br> <i>(Ref. Básica)</i>",
                              "Educación técnica", 
                              "Universidad o posgrado",
                              "Ns/Nr",
                              "Más de 25 libros <br> <i>(Ref. menos de 25)</i>", 
                              "Aceptación diversidad apoderados", 
                              "Conocimiento cívico medio <br> <i>(Ref. bajo)</i>", 
                              "Conocimiento cívico alto", 
                              "Discusión en sala de clases", 
                              "Promedio discusión en sala", 
                              "Prop. etnia medio <br> <i>(Ref. bajo)</i>", 
                              "Prop. etnia alto",
                              "Prop. inmigrante medio <br> <i>(Ref. bajo)</i>", 
                              "Prop. inmigrante alto",
                              "Promedio escolaridad"),
        caption = "Aceptar la diversidad en el vecindario",
        caption.above = TRUE,
        file = "reg.html")

webshot(url ="reg.html" ,file ="IPO/output/tables/reg.png")
```  


```{r results='asis', message=FALSE, echo=FALSE}  
htmlreg(list(reg7, reg8, reg10), 
         custom.model.names = c("Modelo 1",
                               "Modelo 2",
                               "Modelo 3"), 
        custom.note = "$***p <$ 0.001, $**p <$ 0.01, $*p <$ 0.05",
        custom.coef.names = c("Intercepto", 
                              "Educación media <br> <i>(Ref. Básica)</i>",
                              "Educación técnica", 
                              "Universidad o posgrado",
                              "Ns/Nr",
                              "Más de 25 libros <br> <i>(Ref. menos de 25)</i>", 
                              "Aceptación diversidad apoderados", 
                              "Conocimiento cívico medio <br> <i>(Ref. bajo</i>", 
                              "Conocimiento cívico alto", 
                              "Discusión en sala de clases", 
                              "Promedio discusión en sala", 
                              "Prop. etnia medio <br> <i>(Ref. bajo</i>", 
                              "Prop. etnia alto",
                              "Prop. inmigrante medio <br> <i>(Ref. bajo</i>", 
                              "Prop. inmigrante alto",
                              "Promedio escolaridad", 
                              "Aceptación diversidad apoderados * discusión en sala", 
                              "Aceptación diversidad apoderados * prop. inmigrante medio", 
                              "Aceptación diversidad apoderados * prop. inmigrante alte", 
                              "Aceptación diversidad apoderados * escolaridad"),
        caption = "Aceptar la diversidad en el vecindario",
        caption.above = TRUE,
        file = "interac.html")

webshot(url ="interac.html" ,file ="IPO/output/tables/interac.png")
```  




```{r}
plot1 <- plot_model(reg10.1, title = "", show.values = TRUE, value.offset = .35, axis.labels = c("Promedio escolaridad", "Cantidad inmigrantes", "Cantidad de pueblos originarios", "Promedio discusión en aula", "Discusión en aula", "Conocimiento cívico (alto)", "Conocimiento cívico (medio)", "Aceptación diversidad apoderados", "Más de 25 libros", "Ns/Nr", "Universidad o postgrado", "Educación Técnica", "Educación media"))

ggsave(plot1, file="IPO/output/graphs/plot1.png")
```




