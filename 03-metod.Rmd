# Metodología

## Datos

La base de datos a utilizar corresponde al Primer Estudio de Educación Ciudadana en Chile, realizado por la Agencia de Calidad de la Educación del Ministerio de Educación. En este estudio se evaluaron estudiantes de octavo básico provenientes de 242 escuelas. La fecha de aplicación fue el 9 de noviembre de 2017.

Se utilizan tres bases de datos disponibles para este estudio. Primero, se cuenta con una base de datos de 10.213 estudiantes que poseen variables de identificación (8 variables) y el puntaje de la prueba de conocimiento cívico (1 variable). Además, se encuentra disponible una segunda base de datos que contiene las preguntas del cuestionario de Formación Ciudadana, que posee las respuestas de 8.589 estudiantes (222 variables). Al juntar ambas bases de datos el N final es de 8.589 estudiantes. Finalmente, se encuentra disponible una tercera base de datos que contiene las preguntas del cuestionario de Formación Ciudadana, con las respuestas de 6.770 apoderados (141 variables). Al juntar todas las bases de datos, el N total de respuestas completas es de 6.511 estudiantes y apoderados.

Sumado a lo anterior, para las variables del territorio se utilizará la base de datos del CENSO 2017, obtenida a partir del paquete estadístico de R *censo2017* [@vargas_censo2017_2022]. Esta base de datos contiene información respecto de datos territoriales asociados al año 2017 y se encuentra disponible para su libre uso.

## Variables

Con el fin de medir las actitudes de los y las estudiantes hacia la diversidad en sus vecindarios se utiliza la batería de preguntas del módulo “Tolerancia y Distancia Social” del cuestionario de estudiantes. Estas variables están medidas a partir de las preguntas que se presentan en la Tabla \@ref(tab:tab1) a continuación. 

```{r include=FALSE}
pacman::p_load(summarytools,haven,sjPlot,dplyr,htmlwidgets, webshot, sjlabelled, kableExtra, sjmisc)
load("IPO/input/data/proc/data.RData")
load("IPO/input/data/proc/data_comuna.RData")
data_comuna <- rename(data_comuna, cod_com_alu=p10comuna)
data <- merge(data, data_comuna, by= "cod_com_alu")
data_est <- dplyr::select(data, est_piel,
                                 est_clase,
                                 est_religion,
                                 est_orien_sexual,
                                 est_region,
                                 est_pais,
                                 est_indigena)
```

```{r tab1, results='asis', message=FALSE, echo=FALSE}  
print(dfSummary(data_est,
                plain.ascii = F,
                varnumbers = F, 
                graph.col = F, 
                style = "grid",
                headings = F),
      method = "render")
```

Para operacionalizar esta batería de preguntas, en primer lugar, se recodificarán los ítems de modo que 0 indique que no le gustaría que cada uno de los grupos viva en su vecindario y 1 indique que sí le gustaría. Luego, se construirá un índice sumativo a partir de la suma de los ítems para representar el grado de aceptación de todos los grupos. La distribución de este índice se puede observar en el Gráfico \@ref(fig:ind-est). El valor de Alpha de Cronbach de este índice es de 0.887

```{r ind-est, echo=F, fig.cap="Indice aceptacion de la diversidad (estudiantes)"}
data$est_piel_rec <- as.numeric(data$est_piel)
data$est_clase_rec <- as.numeric(data$est_clase)
data$est_religion_rec <- as.numeric(data$est_religion)
data$est_orien_sexual_rec <- as.numeric(data$est_orien_sexual)
data$est_region_rec <- as.numeric(data$est_region)
data$est_pais_rec <- as.numeric(data$est_pais)
data$est_indigena_rec <- as.numeric(data$est_indigena)

data$est_piel_rec <- car::recode(data$est_piel_rec, "1=0; 2=1")
data$est_clase_rec <- car::recode(data$est_clase_rec, "1=0; 2=1")
data$est_religion_rec <- car::recode(data$est_religion_rec, "1=0; 2=1")
data$est_orien_sexual_rec <- car::recode(data$est_orien_sexual_rec, "1=0; 2=1")
data$est_region_rec <- car::recode(data$est_region_rec, "1=0; 2=1")
data$est_pais_rec <- car::recode(data$est_pais_rec, "1=0; 2=1")
data$est_indigena_rec <- car::recode(data$est_indigena_rec, "1=0; 2=1")

data <- data %>% rowwise() %>% mutate(est_acc_div = sum(est_piel_rec, est_clase_rec, est_religion_rec, est_orien_sexual_rec, est_region_rec, est_pais_rec, est_indigena_rec, na.rm = T))

sjPlot::plot_frq(data$est_acc_div,
                 type = "bar",
                 axis.title = "Aceptación de la diversidad en el vecindario
                 Fuente: Elaboración propia",
                 geom.colors = "coral")
```

En relación con las variables independientes, estas se dividen en tres grupos: 1) variables de la familia, 2) variables de la escuela y 3) variables del territorio.

1)	Variables de la familia: 

Los recursos socioeconómicos son representados a partir de dos variables:

*	Nivel educacional (Nivel más alto entre respondente y Cónyuge/pareja): Esta variable es reportada por apoderados. Es categórica y se representa en una escala de 1 a 10, siendo 10 el nivel educacional más alto posible.

*	Cantidad de libros en el hogar: Variable categórica que identifica la cantidad de libros en el hogar según el estudiante. Las categorías de respuesta son: 1) 0 a 10 libros; 2) 11 a 25 libros; 3) 26 a 100 libros; 4) 101 a 200 libros; y 5) 200 o más libros.

Actitudes de la familia:

*	Aceptación de la diversidad de apoderados: se construye de la misma forma en que se operacionalizará la variable dependiente.

2) Variables de la escuela

* Conocimiento cívico: variable “puntaje” obtenida a partir de la prueba de conocimiento cívico aplicada a los y las estudiantes.

* Apertura a la discusión en el aula: Esta variable refiere a la percepción de los y las estudiantes sobre los espacios e instancias disponibles para discutir y opinar sobre diversos temas. Se construirá un índice promedio a partir de las variables disponibles

Un resumen de estas variables se presenta en la Tabla a continuación.


```{r include=FALSE}
data$apod_acc_div <- sjlabelled::set_label(data$apod_acc_div, 'Aceptación de la diversidad (apoderados)')

# educacion
data$educacion_rec <- ifelse(is.na(data$apod_educ), "Ns/Nr", data$apod_educ) # crea categoria Na para no perder casos
data <- data %>% rowwise() %>%  mutate(educacion_rec = case_when(educacion_rec==1~"Ed Basica",
                                                 educacion_rec==2~"Ed Basica",
                                                 educacion_rec==3~"Ed Basica",
                                                 educacion_rec==4~"Ed Media",
                                                 educacion_rec==5~"Ed Media",
                                                 educacion_rec==6~"Ed Tecnica",
                                                 educacion_rec==7~"Ed Tecnica",
                                                 educacion_rec==8~"Universidad o posgrado",
                                                 educacion_rec==9~"Universidad o posgrado",
                                                 educacion_rec==10~"Universidad o posgrado",
                                                 educacion_rec=="Ns/Nr"~"Ns/Nr"
                                                 )) # recodificar en menos categorias
data$educacion_rec <- factor(data$educacion_rec, levels = c("Ed Basica", "Ed Media", "Ed Tecnica", "Universidad o posgrado", "Ns/Nr")) # relevel porque queda con orden distinto

# libros
data$libros_rec <- as.numeric(data$libros)
data <- data %>% rowwise() %>% mutate(libros_rec = case_when(libros_rec==1 ~ "Menos de 25",
                                                             libros_rec==2 ~ "Menos de 25",
                                                             libros_rec==3 ~ "Más de 25",
                                                             libros_rec==4 ~ "Más de 25",
                                                             libros_rec==5 ~ "Más de 25")) # dejar solo dos categorias
data$libros_rec <- factor(data$libros_rec, levels = c("Menos de 25", "Más de 25"))

# c civic
data$civic <- ntile(data$c_civic,3) # categorizar el puntaje en bajo, medio y alto
data$civic <- factor(data$civic, labels = c("Bajo", "Medio", "Alto"))

# mean ap dis
data <- data %>% group_by(mrbd) %>% mutate(mean_apdis = mean(ap_dis, na.rm=TRUE)) %>% ungroup()

data$civic <- sjlabelled::set_label(data$civic, 'Conocimiento cívico')
data$ap_dis <- sjlabelled::set_label(data$ap_dis, 'Índice apertura a la discusión en el aula')
data$mean_apdis <- sjlabelled::set_label(data$mean_apdis, 'Promedio apertura a la discusión en el aula')
data$educacion_rec <- sjlabelled::set_label(data$educacion_rec, 'Nivel educacional apoderados')
data$libros_rec <- sjlabelled::set_label(data$ap_dis, 'Cantidad de libros en el hogar')

data_indep <- dplyr::select(data,
                            educacion_rec,
                              libros_rec,
                              apod_acc_div,
                              civic,
                              ap_dis,
                            mean_apdis)
```


```{r echo=FALSE, results='asis'}
print(dfSummary(data_indep,
                plain.ascii = F,
                varnumbers = F, 
                graph.col = F, 
                style = "grid",
                headings = F),
      method = "render")

```

```{r include=FALSE}
# etnia reescalar
data$etnia2 <- ntile(data$prop_etnia,3) # categorizar el puntaje en bajo, medio y alto
data$etnia2 <- factor(data$etnia2, labels = c("Bajo", "Medio", "Alto"))


# inmigrante reescalar
data$inmigrante2 <- ntile(data$prop_inm,3) # categorizar el puntaje en bajo, medio y alto
data$inmigrante2 <- factor(data$inmigrante2, labels = c("Bajo", "Medio", "Alto"))


data_terr <- dplyr::select(data,
                            etnia2,
                            inmigrante2,
                            escolaridad)


data_terr$etnia2 <- sjlabelled::set_label(data_terr$etnia2, 'Proporción de personas que se identifica con alguna etnia')
data_terr$inmigrante2 <- sjlabelled::set_label(data_terr$inmigrante2, 'Proporción de inmigrantes')
data_terr$escolaridad <- sjlabelled::set_label(data_terr$escolaridad, 'Promedio de escolaridad')
```

3) Variables del territorio

* Proporción de personas que se identifica con alguna etnia: Proporción de personas de la comuna que se identifica con pueblos originarios según el Censo 2017. Variable categórica agrupada en Bajo, Medio y Alto.

* Proporción de población migrante: Proporción de inmigrantes en la comuna, a partir de datos del Censo 2017. Variable categórica agrupada en Bajo, Medio y Alto

* Promedio de escolaridad: Escolaridad promedio de la comuna, según datos del Censo 2017. Esta variable posee un rango de 6.9 a 11.2. 

Un resumen de estas variables se muestran en la siguiente tabla:

```{r echo=FALSE, results='asis'}
print(dfSummary(data_terr,
                plain.ascii = F,
                varnumbers = F, 
                graph.col = F, 
                style = "grid",
                headings = F),
      method = "render")
```

## Métodos

La metodología planteada para realizar esta investigación es de carácter cuantitativa. Las hipótesis de esta investigación fueron pre registradas en la plataforma Open Science Framework del Centro de Ciencia Abierta (OSF, Center for Open Science), puede acceder al documento en este [enlace](https://doi.org/10.17605/OSF.IO/URPZQ). El análisis estadístico de esta investigación fue realizado mediante el software libre R versión 4.0.0.

Debido a que la muestra posee una estructura jerárquica de estudiantes anidados en comunas, se estimarán regresiones multinivel para evaluar todas las hipótesis. Reconocer que se trata de estudiantes anidados en comunas permite incluir variables medidas en diferentes niveles de análisis [@aguinis_BestPractice_2013]. Asimismo, realizar una regresión multinivel permite aislar los efectos individuales (estudiantes) de los agregados (comunas) y, a partir de esto, analizar la varianza de los resultados en cada nivel, así como la proporción de la varianza explicada por las variables independientes de cada nivel. Debido a que las características estructurales de los grupos son una dimensión clave para explicar los diferentes resultados que poseen los estudiantes [@trevino_Influence_2018] y porque tanto las comunas como las escuelas pueden diferir entre sí en cuanto a sus valores y normas comunes [@bayramozdemir_How_2020], se hace necesario estimar regresiones multinivel que permitan determinar si los resultados en las actitudes de los estudiantes dependen de sus respuestas a nivel individual o por características agregadas a nivel de comuna.

Conceptualmente, existen razones teóricas para esperar encontrar efectos de interacción entre niveles, por lo que también se evaluaran modelos de análisis de moderación, para así determinar si el tamaño o dirección del efecto de las variables independientes sobre la dependiente dependen de algún modo de una tercera variable [@hayes_introduction_2022]

De esta forma, luego de estimar la correlación intra-clase de los modelos, y siguiendo los pasos recomendados por @aguinis_BestPractice_2013, se establecen 3 tipos generales de hipótesis a evaluar:

* Hipótesis de efectos directos a nivel individual (1, 2, 3 y 4)

* Hipótesis de moderación (5)

* Hipótesis de efectos directos a nivel agregado (6, 7 y 8)
